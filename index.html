<script>
  const mapLabels = {
    dpe: 'DPE',
    amiante: 'Amiante',
    plomb: 'Plomb (CREP)',
    gaz: 'Gaz',
    electricite: 'Électricité',
    erp: 'ERP (État des risques)',
    termites: 'État parasitaire (termites)'
  };

  function val(id){ return (document.getElementById(id)?.value || '').trim(); }
  function checked(id){ return !!document.getElementById(id)?.checked; }

  function getDiagnosticsRecommandes() {
    const year = Number(val('annee-construction'));
    const surface = Number(val('surface'));
    const hasGaz = val('has-gaz') === 'oui';
    const hasElec = val('has-elec') === 'oui';
    const dpeDeja = val('dpe-deja') === 'oui';
    const termitesZone = checked('termite-zone');

    const billed = new Set();
    billed.add('erp');
    if (!dpeDeja) billed.add('dpe');
    if (year && year < 1949) billed.add('plomb');
    if (year && year < 1997) billed.add('amiante');
    if (hasGaz) billed.add('gaz');
    if (hasElec) billed.add('electricite');
    if (termitesZone) billed.add('termites');

    const list = [...billed];
    const surDevis = (surface && surface > 200) || list.length === 0 || list.length > 6;
    return { list, surDevis, surface };
  }

  function computeAndRender() {
    const result = document.getElementById('resultat-devis');
    const hiddenDiag = document.getElementById('diagnostics-a-prevoir');
    const hiddenSurDevis = document.getElementById('sur-devis');
    const message = document.getElementById('message');

    const { list, surDevis, surface } = getDiagnosticsRecommandes();

    hiddenDiag.value = list.map(d => mapLabels[d]).join(', ') || 'Aucun';
    hiddenSurDevis.value = surDevis ? 'oui' : 'non';

    const htmlList = list.length
      ? `<ul>${list.map(d => `<li>${mapLabels[d]}</li>`).join('')}</ul>`
      : `<p>Aucun diagnostic n’a été sélectionné. Nous vous recontactons pour établir un devis.</p>`;

    result.innerHTML = `
      <p><strong>Diagnostics à prévoir :</strong></p>
      ${htmlList}
      <p><strong>Surface :</strong> ${Number.isFinite(surface) ? surface + ' m²' : '—'}</p>
      <p><strong>Statut :</strong> ${surDevis ? 'Sur devis (nous vous recontactons)' : 'Pack calculable (confirmé après échange)'}</p>
      <p class="note">Règles : plomb avant 1949 • amiante avant 1997 • ERP inclus • gaz/élec selon présence • termites selon vérification. Sur devis si &gt;200 m², 0 diag, ou &gt;6 diags.</p>
    `;
    result.hidden = false;

    const resume =
      `Pré-sélection automatique :\n` +
      `- Diagnostics : ${hiddenDiag.value}\n` +
      `- Sur devis : ${hiddenSurDevis.value}\n`;

    message.value = message.value.replace(/\n?Pré-sélection automatique:[\s\S]*$/m, '').trim();
    message.value = `${message.value}\n\n${resume}`.trim();
  }

  document.getElementById('calculer-devis').addEventListener('click', computeAndRender);
  document.getElementById('devis-form').addEventListener('submit', computeAndRender);
</script>
