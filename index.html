<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SR Diagnostics Immobiliers</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;line-height:1.5;background:#f4f8ff;color:#0f2744}
    header{padding:42px 18px;max-width:980px;margin:auto}
    .card{background:#fff;border:1px solid #d4e3fb;border-radius:14px;padding:18px;margin:12px 0;box-shadow:0 4px 18px rgba(32,74,135,.08)}
    h1{margin:0 0 10px;font-size:34px}
    a{color:#1565c0}
    nav{margin:16px 0 0;display:flex;gap:12px;flex-wrap:wrap}
    nav a{padding:8px 12px;border-radius:10px;background:#e8f1ff;text-decoration:none}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .form-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .diag-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    label{display:block;margin:10px 0 6px}
    input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #b9d1f3;background:#fff;color:#0f2744}
    button{padding:12px 14px;border-radius:10px;border:0;background:#1c7df0;color:#fff;font-weight:700;cursor:pointer}
    .result{margin-top:14px;padding:14px;border-radius:12px;background:#eff6ff;border:1px solid #b7d2fb}
    .result ul{margin:8px 0 0 20px}
    .note{font-size:.95rem;opacity:.9}
    .hidden{display:none}
    footer{padding:24px 18px;opacity:.8;max-width:980px;margin:auto}
  </style>
</head>
<body>
  <header>
    <h1>SR Diagnostics Immobiliers</h1>
    <p>Diagnostics immobiliers pour vente & location — DPE, amiante, plomb, électricité, gaz, ERP…</p>
    <p><strong>Contact :</strong> <a href="tel:+33XXXXXXXXX">+33 XX XX XX XX XX</a> • <a href="mailto:contact@srd...">contact@srd...</a></p>
    <nav>
      <a href="index.html">Accueil & devis</a>
      <a href="actualites.html">Actualités</a>
    </nav>
  </header>

  <main style="max-width:980px;margin:auto;padding:0 18px 40px;">
    <div class="grid">
      <div class="card">
        <h2>Prestations</h2>
        <ul>
          <li>DPE</li>
          <li>Amiante (avec / sans mention)</li>
          <li>Plomb (CREP)</li>
          <li>Électricité</li>
          <li>Gaz</li>
          <li>ERP</li>
        </ul>
      </div>
      <div class="card">
        <h2>Zone d’intervention</h2>
        <p>Lens – Douai – Arras – Béthune (à ajuster).</p>
        <p>RDV rapides • Rapport clair • Conseils pédagogiques</p>
      </div>
    </div>

    <div class="card">
      <h2>Commande / devis en ligne</h2>
      <p class="note">Le calcul ci-dessous est indicatif. Validation finale après étude de votre bien.</p>

      <!-- Formulaire Netlify -->
      <form name="devis" method="POST" action="/" data-netlify="true" netlify-honeypot="bot-field" id="devis-form">
        <input type="hidden" name="form-name" value="devis" />
        <p class="hidden"><label>Ne pas remplir ce champ: <input name="bot-field" /></label></p>
        <input type="hidden" name="diagnostics_a_prevoir" id="diagnostics-a-prevoir" />

        <div class="form-grid">
          <div><label for="nom">Nom</label><input id="nom" name="nom" required /></div>
          <div><label for="email">Email</label><input id="email" name="email" type="email" required /></div>
          <div><label for="telephone">Téléphone</label><input id="telephone" name="telephone" /></div>
          <div>
            <label for="type-projet">Type de projet</label>
            <select id="type-projet" name="type_projet" required>
              <option value="">Sélectionner</option>
              <option value="vente">Vente</option>
              <option value="location">Location</option>
            </select>
          </div>
          <div><label for="date-construction">Date de construction</label><input id="date-construction" name="date_construction" type="date" required /></div>
        </div>

        <h3>Installations</h3>
        <div class="form-grid">
          <div><label for="age-gaz">Installation gaz (âge en années)</label><input id="age-gaz" name="age_gaz" type="number" min="0" placeholder="0 si aucune" /></div>
          <div><label for="age-elec">Installation électrique (âge en années)</label><input id="age-elec" name="age_elec" type="number" min="0" placeholder="0 si récente" /></div>
        </div>

        <h3>Diagnostics déjà faits</h3>
        <p class="note">Pour chaque diagnostic, indiquez s’il est absent, présent mais expiré, ou encore valide.</p>
        <div class="diag-grid">
          <div><label for="etat-dpe">DPE</label><select id="etat-dpe" name="etat_dpe"><option value="absent">Absent</option><option value="expire">Présent mais non valide</option><option value="valide">Présent et valide</option></select></div>
          <div><label for="etat-amiante">Amiante</label><select id="etat-amiante" name="etat_amiante"><option value="absent">Absent</option><option value="expire">Présent mais non valide</option><option value="valide">Présent et valide</option></select></div>
          <div><label for="etat-plomb">Plomb (CREP)</label><select id="etat-plomb" name="etat_plomb"><option value="absent">Absent</option><option value="expire">Présent mais non valide</option><option value="valide">Présent et valide</option></select></div>
          <div><label for="etat-gaz">Gaz</label><select id="etat-gaz" name="etat_gaz"><option value="absent">Absent</option><option value="expire">Présent mais non valide</option><option value="valide">Présent et valide</option></select></div>
          <div><label for="etat-electricite">Électricité</label><select id="etat-electricite" name="etat_electricite"><option value="absent">Absent</option><option value="expire">Présent mais non valide</option><option value="valide">Présent et valide</option></select></div>
          <div><label for="etat-erp">ERP</label><select id="etat-erp" name="etat_erp"><option value="absent">Absent</option><option value="expire">Présent mais non valide</option><option value="valide">Présent et valide</option></select></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;">
          <button type="button" id="calculer-devis">Calculer mes diagnostics</button>
          <button type="submit">Envoyer la demande</button>
        </div>

        <div class="result" id="resultat-devis" aria-live="polite" hidden></div>

        <label for="message">Message complémentaire</label>
        <textarea id="message" name="message" rows="5" placeholder="Type de bien, ville, surface, disponibilités…"></textarea>
      </form>
    </div>
  </main>

  <footer>© SR Diagnostics Immobiliers — Mentions légales à compléter</footer>

  <script>
    const mapLabels = { dpe: 'DPE', amiante: 'Amiante', plomb: 'Plomb (CREP)', gaz: 'Gaz', electricite: 'Électricité', erp: 'ERP' };
    const getEtatDiagnostic = (diag) => document.getElementById(`etat-${diag}`).value;

    function getDiagnosticsRecommandes() {
      const dateConstruction = document.getElementById('date-construction').value;
      const ageGaz = Number(document.getElementById('age-gaz').value || 0);
      const ageElec = Number(document.getElementById('age-elec').value || 0);
      const cutoffPlomb = new Date('1949-01-01');
      const cutoffAmiante = new Date('1997-07-01');

      const obligatoires = new Set(['dpe', 'erp']);
      const dateObj = dateConstruction ? new Date(`${dateConstruction}T00:00:00`) : null;

      if (dateObj && dateObj < cutoffPlomb) obligatoires.add('plomb');
      if (dateObj && dateObj < cutoffAmiante) obligatoires.add('amiante');
      if (ageGaz > 15) obligatoires.add('gaz');
      if (ageElec > 15) obligatoires.add('electricite');

      const dejaValides = [...obligatoires].filter((diag) => getEtatDiagnostic(diag) === 'valide');
      const aRealiser = [...obligatoires].filter((diag) => getEtatDiagnostic(diag) !== 'valide');
      return { obligatoires: [...obligatoires], dejaValides, aRealiser };
    }

    function injectResume(obligatoires, dejaValides, aRealiser) {
      const message = document.getElementById('message');
      document.getElementById('diagnostics-a-prevoir').value = aRealiser.map((d) => mapLabels[d]).join(', ') || 'Aucun';

      const resume =
        `Pré-sélection automatique:\n` +
        `- Obligatoires potentiels: ${obligatoires.map((d) => mapLabels[d]).join(', ')}\n` +
        `- Déjà valides: ${dejaValides.length ? dejaValides.map((d) => mapLabels[d]).join(', ') : 'Aucun'}\n` +
        `- À réaliser: ${aRealiser.length ? aRealiser.map((d) => mapLabels[d]).join(', ') : 'Aucun'}`;

      // Nettoie un ancien résumé si déjà présent
      message.value = message.value.replace(/\n?Pré-sélection automatique:[\s\S]*$/m, '').trim();
      message.value = `${message.value}\n\n${resume}`.trim();
    }

    function computeAndRender() {
      const result = document.getElementById('resultat-devis');
      const { obligatoires, dejaValides, aRealiser } = getDiagnosticsRecommandes();

      const listeAR = aRealiser.length
        ? `<ul>${aRealiser.map((diag) => `<li>${mapLabels[diag]}</li>`).join('')}</ul>`
        : '<p>Tous les diagnostics obligatoires semblent déjà disponibles et valides.</p>';

      result.innerHTML =
        `<p><strong>Diagnostics potentiellement obligatoires :</strong> ${obligatoires.map((diag) => mapLabels[diag]).join(', ')}</p>` +
        `<p><strong>Déjà valides :</strong> ${dejaValides.length ? dejaValides.map((diag) => mapLabels[diag]).join(', ') : 'aucun déclaré'}</p>` +
        `<p><strong>À prévoir pour votre devis :</strong></p>` +
        `${listeAR}` +
        `<p class="note">Règles appliquées : plomb avant 1949, amiante avant le 01/07/1997, gaz/électricité si installation de plus de 15 ans.</p>`;

      result.hidden = false;
      injectResume(obligatoires, dejaValides, aRealiser);
    }

    document.getElementById('calculer-devis').addEventListener('click', computeAndRender);
    document.getElementById('devis-form').addEventListener('submit', computeAndRender);
  </script>
</body>
</html>
